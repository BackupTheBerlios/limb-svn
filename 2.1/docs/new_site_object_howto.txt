HOW TO CREATE NEW SITE OBJECT FROM SCRATCH

In order to create new site object you may need to accomplish the following steps:
1) Plan your new site object: whether it's a site object or a content object, probable attributes and required functionality
2) Create a class for it(inherit from site_object or content_object base class)
3) Create a db_table class if you are creating a content object
4) Create a site object controller class for it. 
5) Create action classes to implement functionality
6) Create template files for actions with GUI(good candidates are display, edit, create actions).
7) Register the new site object in the object tree using admin_page's register_new_object action.
8) Assign appropriate access permissions 
9) Create ini-files with localized strings(optional)

PLANNING

Let's imagine we need a sort of very specific catalog. Suppose our catalog
has form of hierarchically linked folders. Every folder 
contains catalog folders as well as catalog objects. To implement this we need 2 types of the new site objects: some_catalog_object and some_catalog_folder. 
Below we'll try to create all necessary classes and templates to implement our catalog
step by step.

some_catalog_folder will be a common site_object as far as it doesn't have
any additional attributes other than 'identifier' and 'title'.
some_catalog_object is a content object since it would be nice for it to support versioning, it has the following attributes:
1) identifier - VARCHAR
2) title - VARCHAR
3) description - VARCHAR
4) price - FLOAT
5) image_id - INTEGER, id of the image from the LIMB media repository

CREATING SITE OBJECT CLASSES

some_catalog_folder class has the following code, we place it in PROJECT_DIR/core/model/site_objects/some_catalog_folder.class.php:

<?php

require_once(LIMB_DIR . 'core/model/site_objects/site_object.class.php');

class some_catalog_folder extends site_object
{    
    function _define_class_properties()
    {
        return array(
            'class_ordr' => 1, // sorting index in tree
            'can_be_parent' => 1,
            'controller_class_name' => 'some_catalog_folder_controller',
            'icon' => '/shared/images/folder.gif' // icon to display in tree
        );
    }
}

?>

some_catalog_object class has the following code, we place it in PROJECT_DIR/core/model/site_objects/some_catalog_object.class.php:

<?php

require_once(LIMB_DIR . 'core/model/site_objects/content_object.class.php');
require_once(LIMB_DIR . 'core/model/shop/cart_item.class.php');

class some_catalog_object extends content_object
{
    function _define_attributes_definition()
    {
        return complex_array :: array_merge(
                parent :: _define_attributes_definition(),
                array(
                    'description' => array('search' => true, 'search_weight' => 1), // tells to the LIMB search engine to index some_catalog_object by 'description' attribute and use 'search_weight' for relevant sorting
                ));
    }

    function _define_class_properties()
    {
        return array(
            'ordr' => 1, //used for sorting in the tree, e.g. folders usually have this one set to 0, it allows to implement 'folders first' sorting
            'can_be_parent' => 0, //whether it can be a folder
            'controller_class_name' => 'catalog_object_controller', //assign it to 
      'auto_identifier' => true //there will be no need to set identifier manually
        );
    }
}

?>

CREATING DB_TABLE CLASSES

Since some_catalog_object is inherited from the content_object base class it
keeps all attributes in one db table by default.
Appropriate db_table class is used for carrying-out fetching/creating/deleting. some_catalog_object_db_table is used by default. 

NOTE: You can override db_table class name for the object by db_table_name property (do not append '_db_table' postfix), e.g. 
    function _define_class_properties()
    {
        return array(
            [...]
      'db_table_name' => 'some_table_name'
        );
    }

some_catalog_object_db_table has the following code, we place it in PROJECT_DIR/core/db_tables/some_catalog_object_db_table.class.php:

<?php
require_once(LIMB_DIR . 'core/db_tables/content_object_db_table.class.php');

class some_catalog_object_db_table extends content_object_db_table
{  
  function _define_columns()
  {
      return array(
      'image_id' => array('type' => 'numeric'),
      'description' => '', //similar to array('type' => 'string')
      'price' => array('type' => 'numeric'),
    );
  }
}
?>

Columns definitions are useful in type casting and filtering. 
String type used if the definition for a column is empty. The list of 
supported types at the moment:
* numeric
* string
* boolean
* date
* datetime

some_catalog_object_db_table class is used by default by some_catalog_object. 
You can override name of the table in the data base, placing some_catalog_object_db_table :: _define_db_table_name() method:

  function _define_db_table_name()
  {
      return 'some_other_name';
  }
 
CREATING CONTROLLERS

The controller defines its site object functionality. Our some_catalog_folder
is able to display itself in 2 lists (admin_display + display),
create child objects and folders, edit and delete itself.

Ok, here goes some_catalog_folder_controller, we place it in PROJECT_DIR/core/controllers/some_catalog_folder_controller.class.php:

<?php

require_once(LIMB_DIR . 'core/controllers/site_object_controller.class.php');
    
class some_catalog_folder_controller extends site_object_controller
{
    function some_catalog_folder_controller()
    {
        $this->_actions = array(
                'display' => array(
                        'permissions_required' => 'r',
                        'template_path' => '/some_catalog_folder/display.html'
                ),
                'admin_display' => array(
                        'permissions_required' => 'rw',
                        'template_path' => '/some_catalog_folder/admin_display.html'
                ),
                'create_some_catalog_folder' => array(
                        'permissions_required' => 'w',
                        'template_path' => '/some_catalog_folder/create.html',
                        'action_path' => '/some_catalog_folder/create_some_catalog_folder_action',
                        'JIP' => true,
                        'popup' => true,
                        'img_src' => '/shared/images/new.folder.gif',
                        'action_name' => strings :: get('create_catalog_folder', 'catalog'),
                        'can_have_access_template' => true,
                ),
                'create_some_catalog_object' => array(
                        'permissions_required' => 'w',
                        'template_path' => '/some_catalog_object/create.html',
                        'action_path' => '/some_catalog_object/create_some_catalog_object_action',
                        'JIP' => true,
                        'popup' => true,
                        'img_src' => '/shared/images/new.generic.gif',
                        'action_name' => strings :: get('create_catalog_object', 'catalog'),
                        'can_have_access_template' => true,
                ),
                'edit' => array(
                        'permissions_required' => 'w',
                        'template_path' => '/some_catalog_folder/edit.html',
                        'action_path' => '/some_catalog_folder/edit_some_catalog_folder_action',
                        'JIP' => true,
                        'popup' => true,
                        'img_src' => '/shared/images/edit.gif',
                        'action_name' => strings :: get('edit_catalog_folder', 'catalog'),
                ),
                'delete' => array(
                        'permissions_required' => 'w',
                        'JIP' => true,
                        'popup' => true,
                        'action_name' => strings :: get('delete_catalog_folder', 'catalog'),
                        'action_path' => '/ some_catalog_folder/delete_some_catalog_folder_action',
                        'template_path' => '/site_object/delete.html',
                        'img_src' => '/shared/images/rem.gif'
                ),
        );
         
        parent :: site_object_controller();
    }
}
?>

Let's clarify some actions attributes:

* 'permissions_required' option tells the necessary permission level a user must have to execute the action.
* 'JIP' flag means whether the action is to be displayed in the template Just In Place controls.
* 'action_name' holds the localized full name of this action.
* 'action_path' option tells the relative path to the action object.
* 'popup' flag means that action should be performed in the popup window.
* 'template_path' points to the relative template file to display the action result.
* 'img_src' is used to display an icon for this action.

It's a turn for the some_catalog_object controller, we place it in PROJECT_DIR/core/controllers/some_catalog_object_controller.class.php:

<?php

require_once(LIMB_DIR . 'core/controllers/site_object_controller.class.php');

class some_catalog_object_controller extends site_object_controller
{
    function some_catalog_object_controller()
    {
        $this->_actions = array(
                'display' => array(
                        'permissions_required' => 'r',
                        'template_path' => '/some_catalog_object/display.html',
                ),
                'admin_display' => array(
                        'permissions_required' => 'rw',
                        'template_path' => '/some_catalog_object/admin_display.html'
                ),
                'edit' => array(
                        'permissions_required' => 'w',
                        'popup' => true,
                        'JIP' => true,
                        'action_name' => strings :: get('edit_catalog_object', 'catalog'),
                        'action_path' => '/some_catalog_object/edit_some_catalog_object_action',
                        'template_path' => '/some_catalog_object/edit.html',
                        'img_src' => '/shared/images/edit.gif'
                ),
                'publish' => array(
                        'permissions_required' => 'w',
                        'popup' => true,
                        'JIP' => true,
                        'action_name' => strings :: get('publish'),
                        'action_path' => '/doc_flow_object/set_publish_status_action',
                        'img_src' => '/shared/images/publish.gif',
                        'can_have_access_template' => true,
                ),
                'unpublish' => array(
                        'permissions_required' => 'w',
                        'popup' => true,
                        'JIP' => true,
                        'action_name' => strings :: get('unpublish'),
                        'action_path' => '/doc_flow_object/set_publish_status_action',
                        'img_src' => '/shared/images/unpublish.gif',
                        'can_have_access_template' => true,
                ),
                'delete' => array(
                        'permissions_required' => 'w',
                        'JIP' => true,
                        'popup' => true,
                        'action_name' => strings :: get('delete_catalog_object', 'catalog'),
                        'action_path' => '/catalog_object/delete_catalog_object_action',
                        'template_path' => '/site_object/delete.html',
                        'img_src' => '/shared/images/rem.gif'
                ),
        );
         
        parent :: site_object_controller();
    }
}
?>

LOCALIZED *.INI FILES

As you may have realized from controllers definition we use strings :: get([...]) calls to get the localized values.
Our catalog.ini file might be as follows:

[extends]

filename = common

[constants]
catalog_object = Some catalog object
catalog_folder = Some catalog folder
image = Image
description = Description
price = Price

CREATING ACTION CLASSES

Let's implement some actions defined in our some_catalog_folder controller.

First goes the 'create' action, we place it in PROJECT_DIR/core/actions/some_catalog_folder/create_some_catalog_folder_action.class.php:

<?php

require_once(LIMB_DIR . 'core/actions/form_create_site_object_action.class.php');

class create_some_catalog_folder_action extends form_create_site_object_action
{
    function create_some_catalog_folder_action()
    {
        $definition = array(
            'site_object' => 'some_catalog_folder',
        );
        
        parent :: form_create_site_object_action('create_some_catalog_folder', $definition);
    }
    
    function _init_validator()
    {
        parent :: _init_validator();

        $this->validator->add_rule(new required_rule('title'));
    }
}

?>

Validating code is the most interesting part: you define rules in _init_validator() method.
You can find a bunch of different rules in LIMB_DIR/core/lib/validators/rules directory.
The code above should be self-explanatory yet you'll definitely want to dig the form_create_site_object_action base class :)

The 'delete' action, we place it in PROJECT_DIR/core/actions/some_catalog_folder/delete_some_catalog_folder_action.class.php:

<?php

require_once(LIMB_DIR . 'core/actions/form_delete_site_object_action.class.php');

class delete_some_catalog_folder_action extends form_delete_site_object_action
{
    function delete_some_catalog_folder_action($name='delete_form')
    {        
        parent :: form_delete_site_object_action($name, array('site_object' => 'some_catalog_folder'));
    }
}

?>

Should be clear enough too.

The 'create' action, we place it in PROJECT_DIR/core/actions/some_catalog_object/create_some_catalog_object_action.class.php:

<?php

class create_some_catalog_object_action extends form_create_site_object_action
{
    function create_some_catalog_object_action()
    {
        $definition = array(
            'site_object' => 'some_catalog_object',
            'datamap' => array(
                'price' => 'price',
                'description' => ' description ',
                'image_id' => 'image_id'
            )
        );
        
        parent :: form_create_site_object_action('some_catalog_object_form', $definition);
    }
    
    function _init_validator()
    {
        parent :: _init_validator();

        $this->validator->add_rule(new required_rule('title'));
        $this->validator->add_rule(new required_rule('description'));
        $this->validator->add_rule(new required_rule('price'));
    }
}

?>

Looks like we have more validating rules around!
Please note that a 'datamap' option in the $definition array defines how request variables should be mapped into site object's attributes.

CREATING TEMPLATE FILES

LIMB templates are active. Usually all db fetching operations are performed by 
templates datasources(not a mandatory behaviour though).

Here is the template for the 'admin_display' action of some_catalog_folder site object, we place it in PROJECT_DIR/design/main/templates/some_catalog_folder/admin_display.html:

<core:WRAP file="admin/admin_display_page.html" placeholder="content">

<span class=jip>
<fetch:MAPPED>
<core:INCLUDE file="jip_actions/extended.html">
</fetch:MAPPED>
</span>

<fetch:SUB_BRANCH target='folders'>
    <core:PARAMETER name='loader_class_name' value='some_catalog_folder'>
    <core:PARAMETER name='order' value='priority=ASC'>
</fetch:SUB_BRANCH>

<fetch:SUB_BRANCH target='some_catalog_objects'>
    <core:PARAMETER name='loader_class_name' value='some_catalog_object'>
    <core:PARAMETER name='order' value='priority=ASC'>
</fetch:SUB_BRANCH>

<grid:LIST id='folders'>
<table width=100%>
<tr>
    <th><grid:SELECTORS_TOGGLER></th>
    <th><locale:STRING name='catalog_folder' file='catalog'></th>
    <th><locale:STRING name='modified_date'></th>
    <th><locale:STRING name='items_order'></th>
    <th><locale:STRING name='actions'></th>
</tr>
<grid:ITERATOR>
<tr class="jip">
<td><core:INCLUDE file="/admin/selector.html"></td>
<td jip='object'><a href='{$path}?action=admin_display'>{$title}({$children})</a></td>
<td><locale:DATE_FORMAT hash_id='modified_date' type='stamp' locale_format='short_date_time'></td>
<td><core:INCLUDE file='/admin/priority_input.html'></td>
<td jip='action'><core:INCLUDE file="jip_actions/normal.html"></td>
</tr>
</grid:ITERATOR>
<tr>
    <td colspan='4' align='left'><core:INCLUDE file='/admin/delete_button.html'></td>
    <td colspan='2'><core:INCLUDE file='/admin/priority_button.html'></td>
</tr>
</table>
</grid:LIST>

<core:INCLUDE file="pager.html">

<grid:LIST id='some_catalog_objects'>
<table width=100%>
<tr>
    <th><grid:SELECTORS_TOGGLER></th>
    <th><locale:STRING name='published_status'></th>
    <th><locale:STRING name='catalog_object' file='catalog'></th>
    <th><locale:STRING name='modified_date'></th>
    <th><locale:STRING name='items_order'></th>
    <th><locale:STRING name='actions'></th>
</tr>
<grid:ITERATOR>
<tr class="jip">
<td><core:INCLUDE file="/admin/selector.html"></td>
<td><core:INCLUDE file="published_status.html"></td>
<td jip='object'><a href='{$path}?action=admin_display'>{$title}</a></td>
<td><locale:DATE_FORMAT hash_id='modified_date' type='stamp' locale_format='short_date_time'></td>
<td><core:INCLUDE file='/admin/priority_input.html'></td>
<td jip='action'><core:INCLUDE file="jip_actions/normal.html"></td>
</tr>
</grid:ITERATOR>
<tr>
    <td colspan='4' align='left'><core:INCLUDE file='/admin/delete_button.html'></td>
    <td><core:INCLUDE file='/admin/priority_button.html'></td>
    <td><core:INCLUDE file='/admin/toggle_publish_status_button.html'></td>
</tr>
</table>
</grid:LIST>

This template contains 2 tables to display child folders and objects.
<fetch:SUB_BRANCH> gets a bunch of child some_catalog_folders at depth=1 by default and
assigns them to target 'folders' component.
<grid:LIST> is used to display tabular data. <grid:LIST> and <grid:ITERATOR>
make output only if the data set has at least one record (<grid:DEFAULT> tag
can be in case of empty data set).

Let's implement template for the 'create' action of the some_catalog_folder site object, we place it in PROJECT_DIR/design/main/templates/some_catalog_folder/create.html:

<core:WRAP file="popup.html" placeholder="content">
<h2><locale:STRING name='catalog_folder_creation' file='catalog'></h2>
<form method="post" name="create_some_catalog_folder" id="create_some_catalog_folder">
  <table width="100%" border="0" cellspacing="2" cellpadding="3">
        <core:INCLUDE file='/admin/admin_form_items/folder_form_fields.html'>
    <tr>
      <td colspan=2 align=center height=30><action_button action="create_some_catalog_folder" name="create" type="submit" id="create" locale_value="create" class="button">
      &nbsp;
      <input name="cancel" type="button" id="cancel" locale_value="close" onclick='window.close();' class="button">
      </td>
    </tr>
  </table>
</form>

And the last is one is the template for the 'create' action of the some_catalog_object site object, we place it in PROJECT_DIR/design/main/templates/some_catalog_object/create.html:

<core:WRAP file="popup.html" placeholder="content">

<form method="post" name="catalog_object_form" id="catalog_object_form">
    <table width=100% border=0 cellspacing=0 cellpadding=0 height=100%>
    <tr>
        <td colspan=2 class=table-title><locale:STRING name='catalog_object_creation' file='catalog'> <h1>"<fetch:MAPPED>{$title}</fetch:MAPPED>"</h1></td>
    </tr>
    <tr>
        <td colspan=2 height=100% valign=top class=com4>
                <core:INCLUDE file="/some_catalog_object/form_fields.html">
        </td>
    </tr>
    <core:INCLUDE file='/admin/admin_form_items/req_info.html'>
  <tr>
    <td colspan=2 align=center height=30><action_button action="create_catalog_object" name="create" type="submit" id="create" locale_value="create" class="button">
    &nbsp;
    <input name="cancel" type="button" id="cancel" locale_value="close" onclick='window.close();' class="button">
    </td>
  </tr>
    </table>    
</form>

As long as the form fields are similar for creating and editing it's convenient to share them, that's why we include them with <core:INCLUDE file="/some_catalog_object/form_fields.html"> tag.
Here's the contents of PROJECT_DIR/design/main/templates/some_catalog_object/form_fields.html:

    <table width=100% border=0 cellspacing=0 cellpadding=0 height=100%>
    <tr>
        <td height=1%>
            <!--BEGIN: tab-->
            <table width=100% border=0 cellspacing=0 cellpadding=0 id=tabulator active=param_req class=tabulator>
            <col span=100 valign=bottom class=form>
            <tr>
                <td class=tab>&nbsp;</td>
                <td id=param_req_box class=tab-active>
                    <table border=0 cellspacing=0 cellpadding=0 height=100%>
                    <tr>
                        <td nowrap class=label-active id=param_req><a href='JavaScript:void(0);'><locale:STRING name='properties'></a></td>
                    </tr>
                    </table>    
                </td>
                <td class=tab id=param_text_box>
                    <table border=0 cellspacing=0 cellpadding=0 height=100%>
                    <tr>
                        <td nowrap class=label id=param_text><a href='JavaScript:void(0);'><locale:STRING name='content'></a></td>
                    </tr>
                    </table>    
                </td>
                <td class=tab width=100%>&nbsp;</td>
            </tr>
            </table>    
            <!--END: tab-->
        </td>
    </tr>
    <core:INCLUDE file='/admin/admin_form_items/errors.html'>
    <tr>
        <td height=100% valign=top>
        
                    <!--BEGIN: tab ¹1-->
                  <table width="100%" border="0" cellspacing="0" cellpadding="0" style='padding:5px 10px 1px 5px;' id=param_req_content>
                      <col align=right width=200 class=labels>
                            <core:INCLUDE file='/admin/admin_form_items/parent_select.html'>
                                                    <core:INCLUDE file='/admin/admin_form_items/title.html'>
                            <core:INCLUDE file='/admin/admin_form_items/image_select.html'>

<tr>
  <td><label for="price"><span class='req'>*</span><locale:STRING name=' price ' file='catalog'></label></td>
  <td><input type="text" name="price" id="price" label="price" class='input' size='10'>
  </td>
</tr>
</table>
                    <!--END: tab ¹1-->

                    <!--BEGIN: tab ¹2-->
                  <table width="100%" border="0" cellspacing="3" cellpadding="0" height=100% id=param_text_content>
                <tr>
                  <td colspan=2><richedit name="description" id="description" label="Description" rows="25" style='width:100%;'></richedit>
                  </td>
                </tr>
                  </table>
                    <!--END: tab ¹2-->

        </td>
    </tr>
    </table>    
<script>
    init_tab('param_req',    'tabulator', 'label', 'tab')
    init_tab('param_text',    'tabulator', 'label', 'tab','window.onresize()')
</script>

<div id='popup_div'></div>